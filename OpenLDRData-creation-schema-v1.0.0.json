
IF EXISTS(select * from sys.databases where name='OpenLDRData')
BEGIN
	EXEC msdb.dbo.sp_delete_database_backuphistory @database_name = N'OpenLDRData'
	ALTER DATABASE [OpenLDRData] SET  SINGLE_USER WITH ROLLBACK IMMEDIATE
	DROP DATABASE [OpenLDRData]
END
GO

USE [OpenLDRData]
GO
/****** Object:  Table [dbo].[AdminScriptRun_LDRData]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AdminScriptRun_LDRData](
	[AdminScriptRunID] [int] IDENTITY(1,1) NOT NULL,
	[ScriptName] [nvarchar](255) NULL,
	[RunTime] [datetime] NULL,
 CONSTRAINT [aaaaaAdminScriptRunID_PK] PRIMARY KEY NONCLUSTERED 
(
	[AdminScriptRunID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
/****** Object:  Table [dbo].[LabResults]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[LabResults](
	[DateTimeStamp] [datetime] NULL,
	[Versionstamp] [varchar](30) NULL,
	[LIMSDateTimeStamp] [datetime] NULL,
	[LIMSVersionStamp] [varchar](30) NULL,
	[RequestID] [varchar](26) NULL,
	[OBRSetID] [int] NULL,
	[OBXSetID] [int] NULL,
	[OBXSubID] [int] NULL,
	[LOINCCode] [varchar](30) NULL,
	[HL7ResultTypeCode] [varchar](2) NULL,
	[SIValue] [float] NULL,
	[SIUnits] [varchar](25) NULL,
	[SILoRange] [float] NULL,
	[SIHiRange] [float] NULL,
	[HL7AbnormalFlagCodes] [varchar](5) NULL,
	[DateTimeValue] [datetime] NULL,
	[CodedValue] [varchar](1) NULL,
	[ResultSemiquantitive] [int] NULL,
	[Note] [bit] NULL,
	[LIMSObservationCode] [varchar](10) NULL,
	[LIMSObservationDesc] [varchar](50) NULL,
	[LIMSRptResult] [varchar](80) NULL,
	[LIMSRptUnits] [varchar](25) NULL,
	[LIMSRptFlag] [varchar](25) NULL,
	[LIMSRptRange] [varchar](25) NULL,
	[LIMSCodedValue] [varchar](5) NULL,
	[WorkUnits] [float] NULL,
	[CostUnits] [float] NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Monitoring]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Monitoring](
	[DateTimeStamp] [datetime] NULL,
	[Versionstamp] [varchar](30) NULL,
	[LIMSDateTimeStamp] [datetime] NULL,
	[LIMSVersionstamp] [varchar](30) NULL,
	[RequestID] [varchar](26) NULL,
	[OBRSetID] [int] NULL,
	[OBXSetID] [int] NULL,
	[OBXSubID] [int] NULL,
	[LOINCCode] [varchar](30) NULL,
	[ORGANISM] [varchar](50) NULL,
	[SurveillanceCode] [varchar](5) NULL,
	[SpecimenDateTime] [datetime] NULL,
	[LIMSObservationCode] [varchar](25) NULL,
	[LIMSObservationDesc] [varchar](50) NULL,
	[LIMSOrganismGroup] [varchar](25) NULL,
	[CodedValue] [varchar](1) NULL,
	[ResultSemiquantitive] [int] NULL,
	[ResultNotConfirmed] [bit] NULL,
	[ResistantDrugs] [varchar](250) NULL,
	[IntermediateDrugs] [varchar](250) NULL,
	[SensitiveDrugs] [varchar](250) NULL,
	[MDRCode] [char](1) NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Patients]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Patients](
	[DateTimeStamp] [datetime] NULL,
	[Versionstamp] [varchar](30) NULL,
	[LIMSDateTimeStamp] [datetime] NULL,
	[LIMSVersionStamp] [varchar](30) NULL,
	[RequestID] [varchar](26) NULL,
	[REFNO] [varchar](56) NULL,
	[REGISTEREDDATE] [datetime] NULL,
	[LOCATION] [varchar](5) NULL,
	[WARD] [varchar](5) NULL,
	[HOSPID] [varchar](26) NULL,
	[NATIONALITY] [varchar](5) NULL,
	[NATIONALID] [varchar](26) NULL,
	[UNIQUEID] [varchar](31) NULL,
	[SURNAME] [varchar](31) NULL,
	[FIRSTNAME] [varchar](31) NULL,
	[INITIALS] [varchar](16) NULL,
	[REFDRCODE] [varchar](5) NULL,
	[REFDR] [varchar](41) NULL,
	[MEDAID] [varchar](5) NULL,
	[MEDAIDNO] [varchar](26) NULL,
	[BILLACCNO] [varchar](23) NULL,
	[TELHOME] [varchar](20) NULL,
	[TELWORK] [varchar](20) NULL,
	[MOBILE] [varchar](20) NULL,
	[EMAIL] [varchar](60) NULL,
	[DOB] [date] NULL,
	[DOBType] [varchar](25) NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[Requests]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[Requests](
	[DateTimeStamp] [datetime] NULL,
	[Versionstamp] [varchar](30) NULL,
	[LIMSDateTimeStamp] [datetime] NULL,
	[LIMSVersionstamp] [varchar](30) NULL,
	[RequestID] [varchar](26) NULL,
	[OBRSetID] [int] NULL,
	[LOINCPanelCode] [varchar](10) NULL,
	[LIMSPanelCode] [varchar](10) NULL,
	[LIMSPanelDesc] [varchar](50) NULL,
	[HL7PriorityCode] [char](1) NULL,
	[SpecimenDateTime] [datetime] NULL,
	[LIMSPreReg_RegistrationDateTime] [datetime] NULL,
	[LIMSPreReg_ReceivedDateTime] [datetime] NULL,
	[LIMSPreReg_RegistrationFacilityCode] [varchar](15) NULL,
	[RegisteredDateTime] [datetime] NULL,
	[ReceivedDateTime] [datetime] NULL,
	[AnalysisDateTime] [datetime] NULL,
	[AuthorisedDateTime] [datetime] NULL,
	[AdmitAttendDateTime] [datetime] NULL,
	[CollectionVolume] [float] NULL,
	[RequestingFacilityCode] [varchar](15) NULL,
	[ReceivingFacilityCode] [varchar](10) NULL,
	[LIMSPointOfCareDesc] [varchar](50) NULL,
	[RequestTypeCode] [varchar](3) NULL,
	[ICD10ClinicalInfoCodes] [varchar](50) NULL,
	[ClinicalInfo] [varchar](250) NULL,
	[HL7SpecimenSourceCode] [varchar](10) NULL,
	[LIMSSpecimenSourceCode] [varchar](10) NULL,
	[LIMSSpecimenSourceDesc] [varchar](50) NULL,
	[HL7SpecimenSiteCode] [varchar](10) NULL,
	[LIMSSpecimenSiteCode] [varchar](10) NULL,
	[LIMSSpecimenSiteDesc] [varchar](50) NULL,
	[WorkUnits] [float] NULL,
	[CostUnits] [float] NULL,
	[HL7SectionCode] [varchar](3) NULL,
	[HL7ResultStatusCode] [char](1) NULL,
	[RegisteredBy] [varchar](250) NULL,
	[TestedBy] [varchar](250) NULL,
	[AuthorisedBy] [varchar](250) NULL,
	[OrderingNotes] [varchar](250) NULL,
	[EncryptedPatientID] [varchar](64) NULL,
	[AgeInYears] [int] NULL,
	[AgeInDays] [int] NULL,
	[HL7SexCode] [char](1) NULL,
	[HL7EthnicGroupCode] [char](3) NULL,
	[Deceased] [bit] NULL,
	[Newborn] [bit] NULL,
	[HL7PatientClassCode] [char](1) NULL,
	[AttendingDoctor] [varchar](50) NULL,
	[TestingFacilityCode] [varchar](10) NULL,
	[ReferringRequestID] [varchar](25) NULL,
	[Therapy] [varchar](250) NULL,
	[LIMSAnalyzerCode] [varchar](10) NULL,
	[TargetTimeDays] [int] NULL,
	[TargetTimeMins] [int] NULL,
	[LIMSRejectionCode] [varchar](10) NULL,
	[LIMSRejectionDesc] [varchar](250) NULL,
	[LIMSFacilityCode] [varchar](15) NULL,
	[Repeated] [tinyint] NULL,
	[LIMSVendorCode] [varchar](4) NULL,
	[RequestingFacilityNationalCode] [varchar](15) NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  Table [dbo].[VersionControl]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[VersionControl](
	[DateTimeStamp] [datetime] NULL,
	[VersionActivationDate] [datetime] NULL,
	[VERBase] [int] NULL,
	[VERUpdate] [int] NULL,
	[VERBuild] [int] NULL,
	[VersionStamp] [varchar](20) NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
/****** Object:  View [dbo].[viewPCR]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/****** Object:  View [dbo].[viewTB]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE VIEW [dbo].[viewTB]
AS 
-- This view grabs the request and a little extra information about LIMSObservationCode = HIVVL
-- This query may eventually need to have some other technical information added like unit and reference ranges but for now just keeping it simple
SELECT 
	req.RequestID, req.OBRSetID, req.LIMSPanelCode, req.LIMSPanelDesc, req.AuthorisedDateTime AS HIVVL_AuthorisedDateTime, 
	req.LIMSRejectionCode AS HIVVL_LIMSRejectionCode, req.LIMSRejectionDesc AS HIVVL_LIMSRejectionDesc,
	lapdt.LIMSRptResult AS LAP_DATE, 
	liso.LIMSRptResult AS Isoniazida,
	lrif.LIMSRptResult AS Rifampicina,
	lmtb.LIMSRptResult AS Complexo_MTB,
	tbar.LIMSRptResult AS Result1, 
	amost.LIMSRptResult AS Positive_Specimen,
	tbadt.LIMSRptResult AS BAAR_Investigation,
	tbart.LIMSRptResult AS BMicroscopia_coloracao,
	tbarii.LIMSRptResult AS Grading,
	riau.LIMSRptResult AS Result2,
	req.AgeInYears, req.AgeInDays, req.HL7SexCode, 
	req.SpecimenDatetime, req.RegisteredDateTime, req.ReceivedDateTime, req.AuthorisedDateTime, req.AnalysisDateTime, req.LIMSRejectionCode, req.LIMSRejectionDesc, 
	req.DateTimeStamp, req.Versionstamp, req.LIMSDateTimeStamp, req.LIMSVersionstamp,
	req.LOINCPanelCode,  req.HL7PriorityCode, req.AdmitAttendDateTime, req.CollectionVolume, 
	req.LIMSFacilityCode, limsFacility.[Description] AS LIMSFacilityName, limsFacility.ProvinceName AS LIMSProvinceName, limsFacility.DistrictName AS LIMSDistrictName,
	req.RequestingFacilityCode, requestingFacility.[Description] AS RequestingFacilityName, requestingFacility.ProvinceName AS RequestingProvinceName, requestingFacility.DistrictName AS RequestingDistrictName,
	req.ReceivingFacilityCode, receivingFacility.[Description] AS ReceivingFacilityName, receivingFacility.ProvinceName AS ReceivingProvinceName, receivingFacility.DistrictName AS ReceivingDistrictName,
	req.TestingFacilityCode, testingFacility.[Description] AS TestingFacilityName, testingFacility.ProvinceName AS testingProvinceName, testingFacility.DistrictName AS TestingDistrictName,
	req.LIMSPointOfCareDesc, req.RequestTypeCode, req.ICD10ClinicalInfoCodes, req.ClinicalInfo, req.HL7SpecimenSourceCode, req.LIMSSpecimenSourceCode, 
	req.LIMSSpecimenSourceDesc, req.HL7SpecimenSiteCode, req.LIMSSpecimenSiteCode, req.LIMSSpecimenSiteDesc, req.WorkUnits, req.CostUnits, 
	req.HL7SectionCode, req.HL7ResultStatusCode, req.RegisteredBy, req.TestedBy, req.AuthorisedBy, req.OrderingNotes, req.EncryptedPatientID, 
	req.HL7EthnicGroupCode, req.Deceased, req.Newborn, req.HL7PatientClassCode, req.AttendingDoctor, 
	req.ReferringRequestID, req.Therapy, req.LIMSAnalyzerCode, req.TargetTimeDays, req.TargetTimeMins, req.Repeated


FROM Requests AS req
------------------
-- LPA Codes -----
------------------
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LAPDT' -- LPA Date
) AS lapdt ON req.RequestID = lapdt.RequestID AND req.OBRSetID = lapdt.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LISO' -- Isoniazida
) AS liso ON req.RequestID = liso.RequestID AND req.OBRSetID = liso.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LRIF' -- Rifampicina
) AS lrif ON req.RequestID = lrif.RequestID AND req.OBRSetID = lrif.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LMTB' -- Identificação Complexo MTB
) AS lmtb ON req.RequestID = lmtb.RequestID AND req.OBRSetID = lmtb.OBRSetID

------------------
-- TBA 1 Codes -----
------------------
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'TBAR1' -- Results
) AS tbar ON req.RequestID = tbar.RequestID AND req.OBRSetID = tbar.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'AMOST' -- Positive specimen
) AS amost ON req.RequestID = amost.RequestID AND req.OBRSetID = amost.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'TBADT' -- BAAR investigation
) AS tbadt ON req.RequestID = tbadt.RequestID AND req.OBRSetID = tbadt.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'TBAR1' -- BMicroscopia coloração AUR-O
) AS tbart ON req.RequestID = tbart.RequestID AND req.OBRSetID = tbart.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'TBAR2' -- Grading
) AS tbarii ON req.RequestID = tbarii.RequestID AND req.OBRSetID = tbarii.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'RIAU' -- Result
) AS riau ON req.RequestID = riau.RequestID AND req.OBRSetID = riau.OBRSetID

LEFT JOIN OpenLDRDict.dbo.viewFacilities AS limsFacility ON req.LIMSFacilityCode = limsFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS requestingFacility ON req.RequestingFacilityCode = requestingFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS receivingFacility ON req.ReceivingFacilityCode = receivingFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS testingFacility ON req.TestingFacilityCode = testingFacility.FacilityCode
WHERE req.LIMSPanelCode = 'LPA' OR req.LIMSPanelCode = 'TBA1' OR req.LIMSPanelCode = 'TBA2' OR req.LIMSPanelCode = 'TSA'






GO
/****** Object:  View [dbo].[viewVL_Info]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[viewVL_Info]
AS 
-- This view grabs the request and extra registration information related to LIMSObservationCode = VIRAL
-- 24-Jul-19 Brett Staib - Added new info fields being added through VIRAL panel CONSE, LABLO
SELECT 
	req.RequestID, req.OBRSetID, req.LIMSPanelCode, req.LIMSPanelDesc, req.AgeInYears, req.AgeInDays, req.HL7SexCode, 
	req.SpecimenDatetime, req.RegisteredDateTime, req.ReceivedDateTime, req.AuthorisedDateTime, req.AnalysisDateTime, req.LIMSRejectionCode, req.LIMSRejectionDesc, 
	CASE WHEN preg.LIMSRptResult Is Null THEN 'Unreported'
		ELSE preg.LIMSRptResult
	END AS Pregnant, -- preg.LIMSObservationCode,
	CASE WHEN bf.LIMSRptResult Is Null THEN 'Unreported'
		ELSE bf.LIMSRptResult
	END AS BreastFeeding, -- bf.LIMSObservationCode,
	CASE WHEN ft.LIMSRptResult Is Null THEN 'Unreported'
		ELSE ft.LIMSRptResult
	END AS FirstTime, -- ft.LIMSObservationCode,
	CASE WHEN cday.LIMSRptResult Is Null THEN 'Unreported'
		ELSE cday.LIMSRptResult
	END AS CollectedDate, -- cday.LIMSObservationCode,
	ctime.LIMSRptResult AS CollectedTime, -- ctime.LIMSObservationCode,
	tarvd.LIMSRptResult AS DataDeInicioDoTARV, -- tarvd.LIMSObservationCode,
	tarvp.LIMSRptResult AS PrimeiraLinha, -- tarvp.LIMSObservationCode,
	tarvs.LIMSRptResult AS SegundaLinha, -- tarvs.LIMSObservationCode,
	TARVQ.LIMSRptResult AS ARTRegimen,
	LABTI.LIMSRptResult AS TypeOfSampleCollection, 
	VIRAD.LIMSRptResult AS LastViralLoadDate, 
	VIRR1.LIMSRptResult AS LastViralLoadResult, 
	LABNO.LIMSRptResult AS RequestingClinician, 
	CONSE.LIMSRptResult AS ConsentimentoParaContacto, 
	LABLO.LIMSRptResult AS LocalDeColheita, 
	dbo.GetReasonForTest(motivo.LIMSRptResult) AS ReasonForTest, 
	req.DateTimeStamp, req.Versionstamp, req.LIMSDateTimeStamp, req.LIMSVersionstamp,
	req.LOINCPanelCode,  req.HL7PriorityCode, req.AdmitAttendDateTime, req.CollectionVolume, 
	req.LIMSFacilityCode, limsFacility.[Description] AS LIMSFacilityName, limsFacility.ProvinceName AS LIMSProvinceName, limsFacility.DistrictName AS LIMSDistrictName,
	req.RequestingFacilityCode, requestingFacility.[Description] AS RequestingFacilityName, requestingFacility.ProvinceName AS RequestingProvinceName, requestingFacility.DistrictName AS RequestingDistrictName,
	req.ReceivingFacilityCode, receivingFacility.[Description] AS ReceivingFacilityName, receivingFacility.ProvinceName AS ReceivingProvinceName, receivingFacility.DistrictName AS ReceivingDistrictName,
	req.TestingFacilityCode, testingFacility.[Description] AS TestingFacilityName, testingFacility.ProvinceName AS testingProvinceName, testingFacility.DistrictName AS TestingDistrictName,
	req.LIMSPointOfCareDesc, req.RequestTypeCode, req.ICD10ClinicalInfoCodes, req.ClinicalInfo, req.HL7SpecimenSourceCode, req.LIMSSpecimenSourceCode, 
	req.LIMSSpecimenSourceDesc, req.HL7SpecimenSiteCode, req.LIMSSpecimenSiteCode, req.LIMSSpecimenSiteDesc, req.WorkUnits, req.CostUnits, 
	req.HL7SectionCode, req.HL7ResultStatusCode, req.RegisteredBy, req.TestedBy, req.AuthorisedBy, req.OrderingNotes, req.EncryptedPatientID, 
	req.HL7EthnicGroupCode, req.Deceased, req.Newborn, req.HL7PatientClassCode, req.AttendingDoctor, req.ReferringRequestID, 
	req.Therapy, req.LIMSAnalyzerCode, req.TargetTimeDays, req.TargetTimeMins, 
	req.Repeated
FROM Requests AS req
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'ENCON' -- Pregnant
) AS preg ON req.RequestID = preg.RequestID AND req.OBRSetID = preg.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'AMAME' -- Breast Feeding
) AS bf ON req.RequestID = bf.RequestID AND req.OBRSetID = bf.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'VIRAP' -- First time
) AS ft ON req.RequestID = ft.RequestID AND req.OBRSetID = ft.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LABDA' -- Collection Day
) AS cday ON req.RequestID = cday.RequestID AND req.OBRSetID = cday.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LABHO' -- Collection Hour
) AS ctime ON req.RequestID = ctime.RequestID AND req.OBRSetID = ctime.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'TARVD' -- Data de in¡cio do TARV
) AS tarvd ON req.RequestID = tarvd.RequestID AND req.OBRSetID = tarvd.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'TARVP' -- Primeira Linha
) AS tarvp ON req.RequestID = tarvp.RequestID AND req.OBRSetID = tarvp.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'TARVS' -- 
) AS tarvs ON req.RequestID = tarvs.RequestID AND req.OBRSetID = tarvs.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'ESCOL' --		Motivo da Requerimento
) AS motivo ON req.RequestID = motivo.RequestID AND req.OBRSetID = motivo.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'TARVQ' --		ART Regimen
) AS TARVQ ON req.RequestID = TARVQ.RequestID AND req.OBRSetID = TARVQ.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LABTI' --		Type of Sample Collection
) AS LABTI ON req.RequestID = LABTI.RequestID AND req.OBRSetID = LABTI.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'VIRAD' --		Last Viral Load Date
) AS VIRAD ON req.RequestID = VIRAD.RequestID AND req.OBRSetID = VIRAD.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'VIRR1' --		Last Viral Load Result
) AS VIRR1 ON req.RequestID = VIRR1.RequestID AND req.OBRSetID = VIRR1.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LABNO' --		Requesting Clinician
) AS LABNO ON req.RequestID = LABNO.RequestID AND req.OBRSetID = LABNO.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'CONSE' -- CONSE Consentimento para contacto
) AS CONSE ON req.RequestID = CONSE.RequestID AND req.OBRSetID = CONSE.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'LABLO' --	LABLO Local de colheita
) AS LABLO ON req.RequestID = LABLO.RequestID AND req.OBRSetID = LABLO.OBRSetID
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS limsFacility ON req.LIMSFacilityCode = limsFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS requestingFacility ON req.RequestingFacilityCode = requestingFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS receivingFacility ON req.ReceivingFacilityCode = receivingFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS testingFacility ON req.TestingFacilityCode = testingFacility.FacilityCode
WHERE req.LIMSPanelCode = 'VIRAL'



GO
/****** Object:  View [dbo].[viewVL_Result]    Script Date: 27/08/2019 08:29:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[viewVL_Result]
AS 
-- This view grabs the request and a little extra information about LIMSObservationCode = HIVVL
-- This query may eventually need to have some other technical information added like unit and reference ranges but for now just keeping it simple
SELECT 
	req.RequestID, req.OBRSetID, req.LIMSPanelCode, req.LIMSPanelDesc, req.AuthorisedDateTime AS HIVVL_AuthorisedDateTime, 
	req.LIMSRejectionCode AS HIVVL_LIMSRejectionCode, req.LIMSRejectionDesc AS HIVVL_LIMSRejectionDesc,
	[dbo].[ViralLoadResultMerge](hivvd.LIMSRptResult,hivvd.LIMSCodedValue) AS HIVVL_ViralLoadResult, 
	[dbo].[ViralLoadResultMerge](hivvr.LIMSRptResult,hivvr.LIMSCodedValue) AS HIVVL_ViralLoadCAPCTM, 
	[dbo].[ViralLoadResultMerge](hivvc.LIMSRptResult,hivvc.LIMSCodedValue) AS HIVVL_Low_value, 
	[dbo].[ViralLoadResultMerge](hivvf.LIMSRptResult,hivvf.LIMSCodedValue) AS HIVVL_Viral, 
	hivrl.LIMSRptResult AS HIVVL_VRLogValue,
	req.AgeInYears, req.AgeInDays, req.HL7SexCode, 
	req.SpecimenDatetime, req.RegisteredDateTime, req.ReceivedDateTime, req.AuthorisedDateTime, req.AnalysisDateTime, req.LIMSRejectionCode, req.LIMSRejectionDesc, 
	req.DateTimeStamp, req.Versionstamp, req.LIMSDateTimeStamp, req.LIMSVersionstamp,
	req.LOINCPanelCode,  req.HL7PriorityCode, req.AdmitAttendDateTime, req.CollectionVolume, 
	req.LIMSFacilityCode, limsFacility.[Description] AS LIMSFacilityName, limsFacility.ProvinceName AS LIMSProvinceName, limsFacility.DistrictName AS LIMSDistrictName,
	req.RequestingFacilityCode, requestingFacility.[Description] AS RequestingFacilityName, requestingFacility.ProvinceName AS RequestingProvinceName, requestingFacility.DistrictName AS RequestingDistrictName,
	req.ReceivingFacilityCode, receivingFacility.[Description] AS ReceivingFacilityName, receivingFacility.ProvinceName AS ReceivingProvinceName, receivingFacility.DistrictName AS ReceivingDistrictName,
	req.TestingFacilityCode, testingFacility.[Description] AS TestingFacilityName, testingFacility.ProvinceName AS testingProvinceName, testingFacility.DistrictName AS TestingDistrictName,
	req.LIMSPointOfCareDesc, req.RequestTypeCode, req.ICD10ClinicalInfoCodes, req.ClinicalInfo, req.HL7SpecimenSourceCode, req.LIMSSpecimenSourceCode, 
	req.LIMSSpecimenSourceDesc, req.HL7SpecimenSiteCode, req.LIMSSpecimenSiteCode, req.LIMSSpecimenSiteDesc, req.WorkUnits, req.CostUnits, 
	req.HL7SectionCode, req.HL7ResultStatusCode, req.RegisteredBy, req.TestedBy, req.AuthorisedBy, req.OrderingNotes, req.EncryptedPatientID, 
	req.HL7EthnicGroupCode, req.Deceased, req.Newborn, req.HL7PatientClassCode, req.AttendingDoctor, 
	req.ReferringRequestID, req.Therapy, req.LIMSAnalyzerCode, req.TargetTimeDays, req.TargetTimeMins, req.Repeated
FROM Requests AS req
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'HIVVD' -- CAP/CTM
) AS hivvd ON req.RequestID = hivvd.RequestID AND req.OBRSetID = hivvd.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'HIVVR' -- Viral Load Result
) AS hivvr ON req.RequestID = hivvr.RequestID AND req.OBRSetID = hivvr.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'HIVVC' -- HIV : Viral load (low value) 
) AS hivvc ON req.RequestID = hivvc.RequestID AND req.OBRSetID = hivvc.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'HIVVF' -- HIV Viral
) AS hivvf ON req.RequestID = hivvf.RequestID AND req.OBRSetID = hivvf.OBRSetID
LEFT JOIN (
	SELECT * FROM LabResults WHERE LIMSObservationCode = 'HIVRL' -- Log Value
) AS hivrl ON req.RequestID = hivrl.RequestID AND req.OBRSetID = hivrl.OBRSetID
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS limsFacility ON req.LIMSFacilityCode = limsFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS requestingFacility ON req.RequestingFacilityCode = requestingFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS receivingFacility ON req.ReceivingFacilityCode = receivingFacility.FacilityCode
LEFT JOIN OpenLDRDict.dbo.viewFacilities AS testingFacility ON req.TestingFacilityCode = testingFacility.FacilityCode
WHERE req.LIMSPanelCode = 'HIVVL'





GO
